<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Middleware Admin</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f8f9fa;
        color: #343a40;
      }
      .navbar-brand {
        font-weight: 600;
        letter-spacing: -0.5px;
      }
      .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
      }
      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
      }
      .card-header {
        background-color: transparent;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        font-weight: 600;
        padding: 1.25rem;
      }
      .nav-pills .nav-link {
        border-radius: 8px;
        padding: 0.75rem 1.25rem;
        font-weight: 500;
        color: #6c757d;
        transition: all 0.2s;
      }
      .nav-pills .nav-link.active {
        background-color: #0d6efd;
        color: white;
        box-shadow: 0 4px 6px rgba(13, 110, 253, 0.2);
      }
      .nav-pills .nav-link:hover:not(.active) {
        background-color: #e9ecef;
        color: #0d6efd;
      }
      .btn {
        border-radius: 8px;
        padding: 0.5rem 1rem;
        font-weight: 500;
        transition: all 0.2s;
      }
      .btn-primary {
        box-shadow: 0 4px 6px rgba(13, 110, 253, 0.2);
      }
      .btn-success {
        box-shadow: 0 4px 6px rgba(25, 135, 84, 0.2);
      }
      .table {
        background-color: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      }
      .table thead th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #e9ecef;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
        padding: 1rem;
      }
      .table tbody td {
        padding: 1rem;
        vertical-align: middle;
      }
      .modal-content {
        border-radius: 16px;
        border: none;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }
      .modal-header {
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        padding: 1.5rem;
      }
      .modal-footer {
        border-top: 1px solid rgba(0, 0, 0, 0.05);
        padding: 1.5rem;
      }
      .form-control {
        border-radius: 8px;
        padding: 0.75rem 1rem;
        border: 1px solid #ced4da;
      }
      .form-control:focus {
        box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.15);
        border-color: #86b7fe;
      }
      .badge {
        padding: 0.5em 0.8em;
        border-radius: 6px;
        font-weight: 500;
      }
      .fade-enter-active,
      .fade-leave-active {
        transition: opacity 0.3s ease;
      }
      .fade-enter-from,
      .fade-leave-to {
        opacity: 0;
      }
      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      ::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
      }
    </style>
  </head>
  <body>
    <div id="app" class="container py-5">
      <div class="d-flex justify-content-between align-items-center mb-5">
        <h1 class="h3 mb-0 text-primary fw-bold">
          <i class="bi bi-cpu me-2"></i>AI Middleware Admin
        </h1>
        <div v-if="token" class="d-flex align-items-center">
          <div class="d-flex align-items-center me-4">
            <div
              class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2"
              style="width: 32px; height: 32px; font-size: 14px"
            >
              {{ userInfo.username.charAt(0).toUpperCase() }}
            </div>
            <span class="fw-medium">{{ userInfo.username }}</span>
          </div>
          <button @click="logout" class="btn btn-outline-danger btn-sm">
            <i class="bi bi-box-arrow-right me-1"></i>退出
          </button>
        </div>
      </div>

      <!-- Login Form -->
      <div v-if="!token" class="row justify-content-center">
        <div class="col-md-5 col-lg-4">
          <div class="card p-4 shadow-lg">
            <div class="text-center mb-4">
              <h3 class="fw-bold">管理员登录</h3>
              <p class="text-muted">请输入您的凭证以继续</p>
            </div>
            <div class="mb-3">
              <label class="form-label fw-medium">用户名</label>
              <div class="input-group">
                <span class="input-group-text bg-light border-end-0"
                  ><i class="bi bi-person"></i
                ></span>
                <input
                  v-model="loginForm.username"
                  type="text"
                  class="form-control border-start-0 ps-0"
                  placeholder="输入用户名"
                  @keyup.enter="login"
                />
              </div>
            </div>
            <div class="mb-4">
              <label class="form-label fw-medium">密码</label>
              <div class="input-group">
                <span class="input-group-text bg-light border-end-0"
                  ><i class="bi bi-lock"></i
                ></span>
                <input
                  v-model="loginForm.password"
                  type="password"
                  class="form-control border-start-0 ps-0"
                  placeholder="输入密码"
                  @keyup.enter="login"
                />
              </div>
            </div>
            <button @click="login" class="btn btn-primary w-100 py-2 fw-bold">
              登 录
            </button>
          </div>
        </div>
      </div>

      <!-- Dashboard -->
      <div v-else>
        <div class="card mb-4 p-2 bg-white">
          <ul class="nav nav-pills nav-fill">
            <li class="nav-item">
              <a
                class="nav-link"
                :class="{ active: currentTab === 'stats' }"
                href="#"
                @click.prevent="currentTab = 'stats'"
              >
                <i class="bi bi-graph-up me-2"></i>统计监控
              </a>
            </li>
            <li class="nav-item">
              <a
                class="nav-link"
                :class="{ active: currentTab === 'keys' }"
                href="#"
                @click.prevent="currentTab = 'keys'"
              >
                <i class="bi bi-key me-2"></i>API Keys
              </a>
            </li>
            <li class="nav-item">
              <a
                class="nav-link"
                :class="{ active: currentTab === 'password' }"
                href="#"
                @click.prevent="currentTab = 'password'"
              >
                <i class="bi bi-shield-lock me-2"></i>修改密码
              </a>
            </li>
          </ul>
        </div>

        <!-- Alert for Forced Password Change -->
        <transition name="fade">
          <div
            v-if="mustChangePassword"
            class="alert alert-warning d-flex align-items-center shadow-sm border-0"
            role="alert"
          >
            <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
            <div>
              <strong>安全警告:</strong>
              系统检测到您必须修改密码才能继续操作。请前往“修改密码”页面进行更新。
            </div>
          </div>
        </transition>

        <!-- Statistics Tab -->
        <transition name="fade" mode="out-in">
          <div v-show="currentTab === 'stats'">
            <!-- Summary Cards -->
            <div class="row g-4 mb-4">
              <div class="col-md-3">
                <div
                  class="card h-100 text-white bg-primary bg-gradient border-0"
                >
                  <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                      <h6 class="card-title opacity-75 mb-0">
                        总 Token 消耗 (30天)
                      </h6>
                      <i class="bi bi-cpu fs-4 opacity-50"></i>
                    </div>
                    <h2 class="display-6 fw-bold mb-0">
                      {{ stats.summary.total_tokens?.toLocaleString() || 0 }}
                    </h2>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div
                  class="card h-100 text-white bg-success bg-gradient border-0"
                >
                  <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                      <h6 class="card-title opacity-75 mb-0">总成本 (USD)</h6>
                      <i class="bi bi-currency-dollar fs-4 opacity-50"></i>
                    </div>
                    <h2 class="display-6 fw-bold mb-0">
                      ${{ stats.summary.total_cost?.toFixed(4) || 0 }}
                    </h2>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card h-100 text-white bg-info bg-gradient border-0">
                  <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                      <h6 class="card-title opacity-75 mb-0">总请求数</h6>
                      <i class="bi bi-chat-dots fs-4 opacity-50"></i>
                    </div>
                    <h2 class="display-6 fw-bold mb-0">
                      {{ stats.summary.request_count?.toLocaleString() || 0 }}
                    </h2>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div
                  class="card h-100 text-white bg-warning bg-gradient border-0"
                >
                  <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                      <h6 class="card-title opacity-75 mb-0">平均响应时间</h6>
                      <i class="bi bi-stopwatch fs-4 opacity-50"></i>
                    </div>
                    <h2 class="display-6 fw-bold mb-0">
                      {{ stats.summary.avg_response_time?.toFixed(2) || 0 }}s
                    </h2>
                  </div>
                </div>
              </div>
            </div>

            <!-- Charts -->
            <div class="row g-4">
              <div class="col-md-8">
                <div class="card h-100">
                  <div class="card-header bg-white">
                    <i class="bi bi-graph-up me-2 text-primary"></i>每日 Token
                    消耗趋势
                  </div>
                  <div class="card-body">
                    <canvas id="dailyChart"></canvas>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card h-100">
                  <div class="card-header bg-white">
                    <i class="bi bi-pie-chart me-2 text-primary"></i
                    >模型使用分布 (Token)
                  </div>
                  <div class="card-body d-flex align-items-center">
                    <canvas id="modelChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </transition>

        <!-- API Keys Tab -->
        <transition name="fade" mode="out-in">
          <div v-show="currentTab === 'keys'">
            <!-- Create Key Form -->
            <div class="card mb-4 p-4 border-0 shadow-sm">
              <h5 class="mb-3 fw-bold text-primary">
                <i class="bi bi-plus-circle me-2"></i>创建新 Key
              </h5>
              <div class="row g-3 align-items-end">
                <div class="col-md-5">
                  <label class="form-label text-muted small">Key 名称</label>
                  <input
                    v-model="newKey.name"
                    type="text"
                    class="form-control"
                    placeholder="例如: 开发测试 Key"
                    maxlength="100"
                  />
                </div>
                <div class="col-md-2">
                  <button @click="createKey" class="btn btn-success w-100">
                    <i class="bi bi-check-lg me-1"></i>创建
                  </button>
                </div>
              </div>
              <transition name="fade">
                <div
                  v-if="createdKey"
                  class="alert alert-success mt-4 d-flex align-items-start shadow-sm"
                >
                  <i class="bi bi-check-circle-fill fs-4 me-3 mt-1"></i>
                  <div class="w-100">
                    <h6 class="alert-heading fw-bold">新 Key 已创建成功!</h6>
                    <div class="input-group mt-2">
                      <input
                        type="text"
                        class="form-control font-monospace bg-white"
                        :value="createdKey"
                        readonly
                      />
                      <button
                        class="btn btn-outline-success"
                        @click="copyText(createdKey)"
                      >
                        <i class="bi bi-clipboard"></i>
                      </button>
                    </div>
                    <small class="text-muted mt-2 d-block"
                      ><i class="bi bi-info-circle me-1"></i
                      >请立即复制保存，出于安全考虑，它将不会再次完整显示。</small
                    >
                  </div>
                </div>
              </transition>
            </div>

            <!-- Keys List -->
            <div class="card border-0 shadow-sm">
              <div class="card-header bg-white py-3">
                <h5 class="mb-0 fw-bold">
                  <i class="bi bi-list-ul me-2 text-primary"></i>API Key 列表
                </h5>
              </div>
              <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle">
                  <thead class="table-light">
                    <tr>
                      <th class="ps-4">ID</th>
                      <th>名称</th>
                      <th>预览</th>
                      <th>状态</th>
                      <th>创建时间</th>
                      <th class="text-end pe-4">操作</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="key in keys" :key="key.id">
                      <td class="ps-4 text-muted">#{{ key.id }}</td>
                      <td class="fw-medium">{{ key.name }}</td>
                      <td>
                        <code
                          class="bg-light px-2 py-1 rounded text-primary border"
                          >{{ key.key_preview }}</code
                        >
                      </td>
                      <td>
                        <span
                          class="badge rounded-pill"
                          :class="key.is_active ? 'bg-success-subtle text-success border border-success-subtle' : 'bg-secondary-subtle text-secondary border border-secondary-subtle'"
                        >
                          <i
                            class="bi me-1"
                            :class="key.is_active ? 'bi-check-circle-fill' : 'bi-dash-circle-fill'"
                          ></i>
                          {{ key.is_active ? '活跃' : '停用' }}
                        </span>
                      </td>
                      <td class="text-muted small">
                        {{ new Date(key.created_at).toLocaleString() }}
                      </td>
                      <td class="text-end pe-4">
                        <div class="btn-group btn-group-sm shadow-sm">
                          <button
                            @click="copyKey(key.id)"
                            class="btn btn-outline-primary"
                            title="复制完整Key"
                          >
                            <i class="bi bi-clipboard"></i>
                          </button>
                          <button
                            @click="openEditModal(key)"
                            class="btn btn-outline-secondary"
                            title="编辑"
                          >
                            <i class="bi bi-pencil"></i>
                          </button>
                          <button
                            @click="deleteKey(key.id)"
                            class="btn btn-outline-danger"
                            title="删除"
                          >
                            <i class="bi bi-trash"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                    <tr v-if="keys.length === 0">
                      <td colspan="6" class="text-center py-5 text-muted">
                        <i class="bi bi-inbox fs-1 d-block mb-2 opacity-50"></i>
                        暂无 API Key 数据
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </transition>

        <!-- Edit Key Modal -->
        <div
          v-if="showEditModal"
          class="modal fade show"
          style="display: block; background-color: rgba(0, 0, 0, 0.5)"
          tabindex="-1"
          @click.self="closeEditModal"
        >
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow-lg">
              <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold">
                  <i class="bi bi-pencil-square me-2 text-primary"></i>编辑 API
                  Key
                </h5>
                <button
                  type="button"
                  class="btn-close"
                  @click="closeEditModal"
                ></button>
              </div>
              <div class="modal-body p-4">
                <div class="mb-3">
                  <label class="form-label fw-medium">名称</label>
                  <input
                    v-model="editForm.name"
                    type="text"
                    class="form-control"
                    placeholder="输入新的名称"
                  />
                </div>
              </div>
              <div class="modal-footer bg-light">
                <button
                  type="button"
                  class="btn btn-light border"
                  @click="closeEditModal"
                >
                  取消
                </button>
                <button
                  type="button"
                  class="btn btn-primary px-4"
                  @click="updateKey"
                >
                  保存更改
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Change Password Tab -->
        <transition name="fade" mode="out-in">
          <div v-show="currentTab === 'password'">
            <div class="row justify-content-center">
              <div class="col-md-6 col-lg-5">
                <div class="card p-4 shadow-sm border-0">
                  <div class="text-center mb-4">
                    <div
                      class="bg-primary bg-opacity-10 text-primary rounded-circle d-inline-flex align-items-center justify-content-center mb-3"
                      style="width: 64px; height: 64px"
                    >
                      <i class="bi bi-shield-lock fs-2"></i>
                    </div>
                    <h4 class="fw-bold">修改密码</h4>
                    <p class="text-muted small">
                      为了安全起见，建议定期更换您的密码
                    </p>
                  </div>

                  <div class="mb-3">
                    <label class="form-label fw-medium">当前密码</label>
                    <input
                      v-model="passwordForm.old_password"
                      type="password"
                      class="form-control"
                      placeholder="输入当前使用的密码"
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label fw-medium">新密码</label>
                    <input
                      v-model="passwordForm.new_password"
                      type="password"
                      class="form-control"
                      placeholder="输入新密码"
                    />
                    <div class="form-text text-muted small">
                      <i class="bi bi-info-circle me-1"></i>密码长度至少 6 位
                    </div>
                  </div>
                  <div class="mb-4">
                    <label class="form-label fw-medium">确认新密码</label>
                    <input
                      v-model="passwordForm.confirm_password"
                      type="password"
                      class="form-control"
                      placeholder="再次输入新密码"
                    />
                  </div>
                  <button
                    @click="changePassword"
                    class="btn btn-primary w-100 py-2 fw-bold"
                  >
                    更新密码
                  </button>
                </div>
              </div>
            </div>
          </div>
        </transition>
      </div>
    </div>

    <script>
      const { createApp, ref, onMounted, watch, nextTick } = Vue;

      createApp({
        setup() {
          const token = ref(localStorage.getItem("admin_token") || "");
          const userInfo = ref(
            JSON.parse(localStorage.getItem("user_info") || "{}")
          );
          const loginForm = ref({ username: "", password: "" });
          const currentTab = ref("stats");
          const mustChangePassword = ref(false);

          // Data
          const keys = ref([]);
          const newKey = ref({ name: "" });
          const createdKey = ref("");

          // Edit Modal State
          const showEditModal = ref(false);
          const editForm = ref({ id: null, name: "" });

          const stats = ref({
            summary: {},
            daily: [],
            models: [],
          });
          const passwordForm = ref({
            old_password: "",
            new_password: "",
            confirm_password: "",
          });

          // Charts instances
          let dailyChart = null;
          let modelChart = null;

          const api = axios.create({
            baseURL: "/api/v1",
          });

          // Add token to requests
          api.interceptors.request.use((config) => {
            if (token.value) {
              config.headers.Authorization = `Bearer ${token.value}`;
            }
            return config;
          });

          // Handle 401 and 403
          api.interceptors.response.use(
            (response) => response,
            (error) => {
              if (error.response) {
                if (error.response.status === 401) {
                  logout();
                } else if (error.response.status === 403) {
                  const detail = error.response.data.detail;
                  if (detail && detail.includes("Password change required")) {
                    mustChangePassword.value = true;
                    currentTab.value = "password";
                    alert("为了您的账户安全，请先修改初始密码。");
                  } else {
                    alert("权限不足: " + detail);
                  }
                }
              }
              return Promise.reject(error);
            }
          );

          const login = async () => {
            try {
              const res = await api.post("/auth/login", {
                username: loginForm.value.username,
                password: loginForm.value.password,
              });

              token.value = res.data.data.access_token;
              localStorage.setItem("admin_token", token.value);

              // Get User Info
              const userRes = await api.get("/users/me");
              userInfo.value = userRes.data.data;
              localStorage.setItem("user_info", JSON.stringify(userInfo.value));

              if (userInfo.value.must_change_password) {
                mustChangePassword.value = true;
                currentTab.value = "password";
              } else {
                fetchStats();
              }
            } catch (e) {
              const msg = e.response?.data?.detail;
              alert(
                "登录失败: " +
                  (typeof msg === "object"
                    ? JSON.stringify(msg)
                    : msg || e.message)
              );
            }
          };

          const logout = () => {
            token.value = "";
            userInfo.value = {};
            localStorage.removeItem("admin_token");
            localStorage.removeItem("user_info");
          };

          const fetchKeys = async () => {
            try {
              const res = await api.get("/api-keys/");
              keys.value = res.data.data.items;
            } catch (e) {
              console.error(e);
            }
          };

          const createKey = async () => {
            if (!newKey.value.name.trim()) {
              alert("请输入 Key 名称");
              return;
            }
            try {
              const res = await api.post("/api-keys/", {
                name: newKey.value.name,
              });
              createdKey.value = res.data.data.key;
              newKey.value.name = "";
              fetchKeys();
            } catch (e) {
              const msg = e.response?.data?.detail;
              alert(
                "创建失败: " +
                  (typeof msg === "object"
                    ? JSON.stringify(msg)
                    : msg || e.message)
              );
            }
          };

          const copyText = async (text) => {
            try {
              await navigator.clipboard.writeText(text);
              alert("已复制到剪贴板");
            } catch (err) {
              console.error("复制失败", err);
            }
          };

          const copyKey = async (id) => {
            try {
              const res = await api.get(`/api-keys/${id}`);
              const fullKey = res.data.data.key;

              if (fullKey) {
                await copyText(fullKey);
              } else {
                alert("无法获取完整 Key");
              }
            } catch (e) {
              const msg = e.response?.data?.detail;
              alert(
                "复制失败: " +
                  (typeof msg === "object"
                    ? JSON.stringify(msg)
                    : msg || e.message)
              );
            }
          };

          const openEditModal = (key) => {
            editForm.value = { id: key.id, name: key.name };
            showEditModal.value = true;
          };

          const closeEditModal = () => {
            showEditModal.value = false;
            editForm.value = { id: null, name: "" };
          };

          const updateKey = async () => {
            if (!editForm.value.name) return;
            try {
              await api.patch(`/api-keys/${editForm.value.id}`, {
                name: editForm.value.name,
              });
              closeEditModal();
              fetchKeys();
            } catch (e) {
              const msg = e.response?.data?.detail;
              alert(
                "更新失败: " +
                  (typeof msg === "object"
                    ? JSON.stringify(msg)
                    : msg || e.message)
              );
            }
          };

          const deleteKey = async (id) => {
            if (!confirm("确定要删除吗？")) return;
            try {
              await api.delete(`/api-keys/${id}`);
              fetchKeys();
            } catch (e) {
              const msg = e.response?.data?.detail;
              alert(
                "删除失败: " +
                  (typeof msg === "object"
                    ? JSON.stringify(msg)
                    : msg || e.message)
              );
            }
          };

          const fetchStats = async () => {
            try {
              const [summaryRes, dailyRes, modelsRes] = await Promise.all([
                api.get("/statistics/summary"),
                api.get("/statistics/daily"),
                api.get("/statistics/models"),
              ]);

              stats.value.summary = summaryRes.data.data;
              stats.value.daily = dailyRes.data.data;
              stats.value.models = modelsRes.data.data;

              renderCharts();
            } catch (e) {
              console.error("Failed to fetch stats", e);
            }
          };

          const renderCharts = () => {
            nextTick(() => {
              const dailyCtx = document.getElementById("dailyChart");
              const modelCtx = document.getElementById("modelChart");

              if (!dailyCtx || !modelCtx) return;

              if (dailyChart) dailyChart.destroy();
              if (modelChart) modelChart.destroy();

              // Daily Chart
              dailyChart = new Chart(dailyCtx, {
                type: "line",
                data: {
                  labels: stats.value.daily.map((d) => d.date),
                  datasets: [
                    {
                      label: "Token 消耗",
                      data: stats.value.daily.map((d) => d.tokens),
                      borderColor: "#0d6efd",
                      backgroundColor: "rgba(13, 110, 253, 0.1)",
                      tension: 0.3,
                      fill: true,
                    },
                  ],
                },
                options: {
                  responsive: true,
                  plugins: {
                    legend: {
                      display: false,
                    },
                  },
                  scales: {
                    y: {
                      beginAtZero: true,
                      grid: {
                        borderDash: [2, 4],
                      },
                    },
                    x: {
                      grid: {
                        display: false,
                      },
                    },
                  },
                },
              });

              // Model Chart
              modelChart = new Chart(modelCtx, {
                type: "doughnut",
                data: {
                  labels: stats.value.models.map((m) => m.model),
                  datasets: [
                    {
                      data: stats.value.models.map((m) => m.tokens),
                      backgroundColor: [
                        "#0d6efd",
                        "#198754",
                        "#ffc107",
                        "#0dcaf0",
                        "#6610f2",
                      ],
                      borderWidth: 0,
                    },
                  ],
                },
                options: {
                  responsive: true,
                  cutout: "70%",
                  plugins: {
                    legend: {
                      position: "right",
                      labels: {
                        usePointStyle: true,
                        padding: 20,
                      },
                    },
                  },
                },
              });
            });
          };

          const changePassword = async () => {
            if (
              passwordForm.value.new_password !==
              passwordForm.value.confirm_password
            ) {
              alert("两次输入的新密码不一致");
              return;
            }

            try {
              await api.post("/users/change-password", {
                old_password: passwordForm.value.old_password,
                new_password: passwordForm.value.new_password,
              });

              alert("密码修改成功，请重新登录");
              mustChangePassword.value = false;
              logout();
            } catch (e) {
              alert("修改失败: " + (e.response?.data?.detail || e.message));
            }
          };

          // Watch tab changes to fetch data
          watch(currentTab, (newTab) => {
            if (newTab === "stats") fetchStats();
            if (newTab === "keys") fetchKeys();
          });

          onMounted(() => {
            if (token.value) {
              if (userInfo.value.must_change_password) {
                mustChangePassword.value = true;
                currentTab.value = "password";
              } else {
                fetchStats();
              }
            }
          });

          return {
            token,
            userInfo,
            loginForm,
            currentTab,
            mustChangePassword,
            keys,
            newKey,
            createdKey,
            showEditModal,
            editForm,
            stats,
            passwordForm,
            login,
            logout,
            createKey,
            copyKey,
            copyText,
            openEditModal,
            closeEditModal,
            updateKey,
            deleteKey,
            changePassword,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
